# 系统开发实施计划（2025-11-08）

> 依据《缺失功能清单.md》和《可扩展功能方案建议书.md》，结合现有架构与工作区规则（数据库设计采用 MySQL、按计划顺序进行开发、完成功能开发后更新到计划书文档），制定分阶段、可落地的实施计划与验收标准。

## 1. 目标与原则
- 完整实现缺失功能清单中的所有模块，确保商业闭环可用。
- 提升系统可扩展性：架构优化、数据库设计优化、接口统一与配置管理完善。
- 建立规范化的研发流程：代码规范、版本控制、代码审查、质量保障与文档更新闭环。
- 分阶段交付，每一阶段产出可演示的功能、测试报告与用户手册。

## 2. 分阶段实施计划（四阶段，约24周）

### 第一阶段（立即开始，周1-6）— 高优先级功能落地
1) 支付系统集成（2-3周）
   - 支付方式：微信支付（扫码/H5）、支付宝（网页/手机）、银联云闪付；信用卡支付（可选）。
   - 流程：创建支付→回调验签→订单状态更新→支付日志/审计→退款（全额/部分）。
   - 安全：密钥加密存储、统一验签（已上线 CallbackSignatureVerifier）、防重复支付、幂等控制。
   - 交付：设计文档《docs/api/支付系统设计.md》；单元测试与集成测试；Swagger API；用户手册更新。
   - SQL：`sql/2025-11-xx__create_payments_and_refunds.sql`（MySQL）。

2) 注册功能 API 集成（1周）
   - 后端注册 API、唯一性校验、手机号验证码、密码强度校验；前端表单校验与自动登录流程。
   - 交付：测试用例覆盖服务与控制器；接口文档更新；用户注册手册。

3) 订单状态实时同步（1-2周）
   - WebSocket 实时推送、轮询备用；状态变更日志与异常回滚；离线状态缓存。
   - 交付：WebSocket 测试方案、端到端集成测试；前端状态同步组件说明文档。

### 第二阶段（周7-12）— 中高优先级与用户价值提升
1) 会员系统（2周）
   - 等级体系、积分系统、权益管理、保级机制；积分记录与兑换。
   - SQL：`member_levels`、`user_points`、`point_records`（MySQL）。
   - 交付：会员系统设计文档；服务/控制器单元测试；集成测试用例与模拟数据。

2) 消息通知系统（1-2周，现有80%完成进行收尾与加固）
   - 短信（阿里云 SMS）、邮件（SMTP）、站内消息、微信模板消息；模板管理、频率控制、用户偏好设置。
   - 交付：通知模板设计与接口文档；渠道适配器测试；性能与可靠性测试报告。

### 第三阶段（周13-18）— 数据与智能能力
1) 数据分析与报表（2-3周）
   - 业务指标、用户行为分析、可视化报表、大屏与导出。
   - 交付：报表设计文档；ETL与聚合策略；前后端集成测试与性能基准。

2) AI 智能客服（3-4周）
   - 对话机器人、预约助手、FAQ 知识库；NLP 能力集成；对话记录与效果分析。
   - 交付：AI 客服技术方案；安全与隐私评估；A/B 实验与效果报告。

### 第四阶段（周19-24）— 业务扩展与多端覆盖（低优先级）
1) 移动端应用（4-6周）
   - 微信小程序与移动 APP（uni-app）；推送通知、定位、离线存储等原生能力。
   - 交付：移动端架构与页面规范；跨端测试计划；发布与版本管理流程。

2) 多门店管理（3-4周）
   - 门店信息、服务配置、容量管理、订单分配；就近推荐与业绩统计。
   - 交付：门店数据模型与接口文档；门店调度算法说明与测试。

3) 营销活动系统（2-3周）
   - 优惠券、促销活动、满减与新用户优惠；使用规则与核销。
   - 交付：营销活动规则引擎设计；活动效果统计与风控策略。

## 3. 可扩展性实施（建议书落地）

### 3.1 架构优化与服务治理
- 微服务架构预留：逐步解耦为 `auth-service`、`payment-service`、`booking-service`、`notification-service`、`reporting-service`。
- API 网关：预研 Spring Cloud Gateway（统一认证、限流、熔断、路由）。
- 消息队列：引入 RabbitMQ/RocketMQ 用于异步任务（通知发送、报表汇总、AI日志）。
- 事件驱动：订单状态与支付事件标准化（`order.updated`、`payment.succeeded`）。

### 3.2 数据库设计优化（MySQL）
- 统一时间类型与时区；主键策略与唯一索引；外键约束与级联策略。
- 为多租户架构预留 `tenant_id` 字段；构建租户路由数据源与按租户隔离策略。
- 表级优化：热表索引优化（`orders`、`payments`）、审计表归档策略、慢查询治理。

### 3.3 接口规范与扩展机制
- 统一 REST 风格与错误码；幂等性（`Idempotency-Key`）、版本化路径（`/api/v1`）。
- 插件/适配器机制：支付网关、消息通道、营销规则、报表导出等模块采用接口+工厂模式（现有 `PaymentGateway` 已落实）。
- 配置管理：集中 `application-*.yml` 与 `@ConfigurationProperties`，密钥加密（如 Jasypt/自定义加密），动态开关。

## 4. 开发规范与流程

### 4.1 代码规范
- 后端：Checkstyle + SpotBugs；统一包结构与命名规范；Controller/Service/Repository 分层。
- 前端：ESLint + Prettier；组件/路由/状态统一风格；TypeScript（可选）。
- 文档：统一模板（设计文档、测试方案、用户手册），存放于 `docs/` 目录。

### 4.2 版本控制
- 分支模型：`main`（稳定）、`develop`（集成）、`feature/*`（功能）、`hotfix/*`（紧急修复）。
- 提交规范：Conventional Commits；PR 模板与评审清单；CI 自动化检查与测试。

### 4.3 质量保证
- 单元测试：覆盖服务/控制器/工具类，覆盖率目标 ≥ 70%。
- 集成测试：端到端流程（含支付回调与订单同步）；测试环境数据隔离；回归测试清单。
- 安全测试：验签、权限、注入/XSS、防重放；密钥与配置泄漏扫描。
- 性能测试：核心接口延迟 ≤ 200ms、支付回调处理 ≤ 1s、WebSocket并发稳定性。

## 5. 交付要求
- 每阶段交付可演示的完整功能模块（前后端协同演示）。
- 提供详细测试报告（单元、集成、性能、安全）与用户手册。
- 完成系统性能优化与安全加固项（限流、熔断、审计、告警）。

## 6. 验收标准
- 缺失功能全部实现并通过测试，支付闭环可用（含退款）。
- 扩展能力达到建议书要求：微服务预留、消息队列集成、配置中心与租户预留。
- 性能与稳定性：核心接口 SLO 达标；质量与安全扫描通过。
- 文档完整：设计/测试/用户手册与《系统开发计划书.md》按阶段及时更新。

## 7. 里程碑与产出物
- M1（周6）：支付系统、注册、订单同步完成；测试与文档交付。
- M2（周12）：会员与通知完成；用户体验优化与测试报告。
- M3（周18）：数据分析与 AI 客服完成；性能与安全评估通过。
- M4（周24）：移动端/多门店/营销系统完成；上线准备与交付清单。

## 8. 文档更新与合规
- 每个模块完成后：
  - 更新《系统开发计划书.md》“最新开发日志”和进度表。
  - 发布设计文档、测试报告与用户手册到 `docs/`。
  - 提交数据库迁移脚本到 `sql/`，并记录变更说明。

### 今日更新（2025-11-08）
- 支付审计日志功能完成并上线：
  - 新增实体与Mapper：`PaymentAudit`、`PaymentAuditMapper`
  - 新增SQL：`sql/2025-11-08__create_payment_audit.sql`
  - 在 `PaymentServiceImpl` 关键流程插入审计事件（创建/网关调用/查询/状态变更/回调验签与更新/退款/超时取消）
  - 文档新增：`docs/api/支付系统设计-网关回调与审计.md`
- 单元测试通过：`PaymentServiceImplVirtualGatewayTest`
- 按计划更新《系统开发计划书.md》最新开发日志，标记第一阶段支付系统集成与订单状态同步完成。

### 操作指引（DB与部署）
- 数据库迁移：在MySQL执行 `sql/2025-11-08__create_payment_audit.sql` 以创建 `payment_audit` 表。
- 后端部署：无需额外配置即可记录审计（`PaymentAuditMapper` 支持空注入时兼容运行）。

---

如需调整优先级或周期，将在每阶段结束进行复盘与计划迭代，确保按计划顺序推进并满足业务目标。