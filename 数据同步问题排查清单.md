# 数据同步问题排查清单

## 🚨 紧急问题快速排查

### 1. 服务无法启动
- [ ] 检查端口占用：`netstat -ano | findstr :3003` 和 `netstat -ano | findstr :8080`
- [ ] 检查MySQL服务：`net start mysql80`
- [ ] 检查Java版本：`java -version`（需要JDK 11+）
- [ ] 检查Node.js版本：`node -v`（需要18+）

### 2. API连接失败
- [ ] 后端服务是否正常启动
- [ ] 访问 http://localhost:8080/api/test/health 检查后端状态
- [ ] 检查防火墙设置
- [ ] 检查网络代理配置

### 3. 数据库连接异常
- [ ] MySQL服务是否运行：`services.msc` 查看MySQL80服务
- [ ] 数据库是否存在：`mysql -u root -p -e "SHOW DATABASES;"`
- [ ] 用户权限是否正确
- [ ] 连接配置是否正确（application.yml）

## 🔍 系统性问题诊断

### 步骤1：基础环境检查

```bash
# 检查服务状态
curl http://localhost:8080/api/test/health
curl http://localhost:3003

# 检查数据库连接
mysql -u root -p -e "USE carwash_db; SELECT COUNT(*) FROM bookings;"
```

### 步骤2：使用诊断工具

1. **访问诊断页面**：http://localhost:3003/data-sync-test
2. **运行快速诊断**：点击"快速诊断"按钮
3. **查看问题报告**：检查发现的问题类型和严重程度
4. **执行自动修复**：点击"快速修复"按钮

### 步骤3：手动验证

```javascript
// 在浏览器控制台执行
// 1. 检查API配置
console.log('API配置:', API_CONFIG)

// 2. 测试API连接
fetch('/api/test/health').then(r => r.json()).then(console.log)

// 3. 检查订单数据
fetch('/api/bookings/admin/all').then(r => r.json()).then(console.log)
```

## 📋 常见问题及解决方案

### 问题1：前端显示"网络错误"

**可能原因**：
- 后端服务未启动
- 端口配置错误
- CORS配置问题

**解决步骤**：
1. 检查后端服务状态
2. 验证API_CONFIG.BASE_URL配置
3. 检查后端CORS配置

**验证命令**：
```bash
# 检查后端服务
curl http://localhost:8080/api/test/health

# 检查端口占用
netstat -ano | findstr :8080
```

### 问题2：订单状态更新失败

**可能原因**：
- 状态值不匹配
- 权限验证失败
- 数据库约束错误

**解决步骤**：
1. 检查状态映射配置
2. 验证用户权限
3. 查看后端错误日志

**调试代码**：
```javascript
// 检查状态映射
import { STATUS_MAPPING } from '@/utils/dataSync.js'
console.log('状态映射:', STATUS_MAPPING)

// 测试状态更新
await orderApi.updateOrderStatus(1, 'confirmed')
```

### 问题3：数据不同步

**可能原因**：
- 缓存问题
- 事务回滚
- 网络中断

**解决步骤**：
1. 清除浏览器缓存
2. 检查数据库事务日志
3. 运行数据一致性检查

**修复命令**：
```javascript
// 强制刷新数据
await refreshBookingDataSync(orderApi, (data) => {
  console.log('刷新数据:', data)
})

// 清除本地缓存
localStorage.clear()
sessionStorage.clear()
```

### 问题4：页面加载缓慢

**可能原因**：
- 数据量过大
- 网络延迟
- 资源加载问题

**解决步骤**：
1. 启用数据分页
2. 优化网络请求
3. 使用CDN加速

**优化配置**：
```javascript
// 启用请求缓存
const request = axios.create({
  timeout: 10000,
  cache: true
})

// 数据分页
const pageSize = 20
const currentPage = 1
```

## 🛠️ 高级排查技巧

### 1. 网络请求监控

```javascript
// 拦截所有请求
const originalFetch = window.fetch
window.fetch = function(...args) {
  console.log('请求:', args[0])
  return originalFetch.apply(this, args)
    .then(response => {
      console.log('响应:', response.status, args[0])
      return response
    })
}
```

### 2. 数据库查询监控

```sql
-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看连接状态
SHOW PROCESSLIST;

-- 查看表锁状态
SHOW OPEN TABLES WHERE In_use > 0;
```

### 3. 后端日志分析

```bash
# 查看应用日志
tail -f logs/application.log

# 过滤错误日志
grep "ERROR" logs/application.log

# 查看特定时间段日志
grep "2025-11-01 10:" logs/application.log
```

### 4. 前端性能分析

```javascript
// 性能监控
performance.mark('sync-start')
await syncOperation()
performance.mark('sync-end')
performance.measure('sync-duration', 'sync-start', 'sync-end')

// 查看性能指标
console.log(performance.getEntriesByType('measure'))
```

## 📊 监控指标说明

### 关键性能指标(KPI)

| 指标 | 正常范围 | 警告阈值 | 严重阈值 |
|------|----------|----------|----------|
| API响应时间 | < 1秒 | 1-3秒 | > 3秒 |
| 数据同步成功率 | > 98% | 95-98% | < 95% |
| 错误率 | < 1% | 1-5% | > 5% |
| 数据一致性 | > 99% | 95-99% | < 95% |

### 健康状态等级

- **优秀(90-100分)**：系统运行正常，无需干预
- **良好(70-89分)**：系统基本正常，建议关注
- **一般(50-69分)**：存在问题，需要处理
- **需要关注(<50分)**：严重问题，立即处理

## 🔧 自动化修复脚本

### 1. 数据库修复脚本

```sql
-- 修复订单状态不一致
UPDATE bookings 
SET status = 'pending' 
WHERE status NOT IN ('pending', 'confirmed', 'in_progress', 'completed', 'cancelled');

-- 修复时间戳问题
UPDATE bookings 
SET updated_at = NOW() 
WHERE updated_at IS NULL;
```

### 2. 缓存清理脚本

```javascript
// 清理前端缓存
function clearAllCache() {
  // 清理localStorage
  localStorage.clear()
  
  // 清理sessionStorage
  sessionStorage.clear()
  
  // 清理IndexedDB
  if ('indexedDB' in window) {
    indexedDB.deleteDatabase('app-cache')
  }
  
  console.log('✅ 缓存清理完成')
}
```

### 3. 服务重启脚本

```bash
#!/bin/bash
# restart-services.sh

echo "重启数据同步服务..."

# 停止服务
pkill -f "spring-boot:run"
pkill -f "npm run dev"

# 等待服务停止
sleep 5

# 启动MySQL
net start mysql80

# 启动后端服务
cd backend
nohup mvn spring-boot:run > backend.log 2>&1 &

# 启动前端服务
cd ../frontend
nohup npm run dev > frontend.log 2>&1 &

echo "✅ 服务重启完成"
```

## 📞 技术支持

### 联系方式
- **技术文档**：查看项目README.md
- **问题反馈**：提交GitHub Issue
- **紧急支持**：查看错误日志并按本清单排查

### 常用命令速查

```bash
# 服务管理
net start mysql80                    # 启动MySQL
mvn spring-boot:run                  # 启动后端
npm run dev                          # 启动前端

# 日志查看
tail -f logs/application.log         # 后端日志
F12 -> Console                       # 前端日志

# 数据库操作
mysql -u root -p                     # 连接数据库
USE carwash_db;                      # 选择数据库
SHOW TABLES;                         # 查看表

# 网络诊断
curl http://localhost:8080/api/test/health  # 后端健康检查
ping localhost                              # 本地连接测试
```

---

**使用说明**：
1. 遇到问题时，按照清单逐项检查
2. 优先使用自动诊断工具
3. 记录问题和解决方案，便于后续参考
4. 定期运行健康检查，预防问题发生

**最后更新**：2025-11-01