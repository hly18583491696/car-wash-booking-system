<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 测试</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>预约状态更新 API 测试</h1>
    
    <div>
        <h3>1. 先登录获取 Token</h3>
        <button onclick="login()">管理员登录</button>
        <div id="loginResult"></div>
    </div>
    
    <div>
        <h3>2. 获取订单列表</h3>
        <button onclick="getBookings()">获取订单</button>
        <div id="bookingsResult"></div>
    </div>
    
    <div>
        <h3>3. 更新订单状态</h3>
        <input type="number" id="bookingId" placeholder="订单ID" value="1">
        <select id="status">
            <option value="confirmed">已确认</option>
            <option value="processing">进行中</option>
            <option value="completed">已完成</option>
            <option value="cancelled">已取消</option>
        </select>
        <button onclick="updateStatus()">更新状态</button>
        <div id="updateResult"></div>
    </div>

    <script>
        let token = '';
        
        // 配置 axios
        axios.defaults.baseURL = 'http://localhost:8080/api';
        
        // 请求拦截器
        axios.interceptors.request.use(config => {
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            console.log('Request:', config.method?.toUpperCase(), config.url, config.data || config.params);
            return config;
        });
        
        // 响应拦截器
        axios.interceptors.response.use(
            response => {
                console.log('Response:', response.config.url, response.data);
                return response.data;
            },
            error => {
                console.error('Error:', error);
                return Promise.reject(error);
            }
        );
        
        async function login() {
            try {
                const response = await axios.post('/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.code === 200) {
                    token = response.data.token;
                    document.getElementById('loginResult').innerHTML = 
                        `<p style="color: green;">登录成功！Token: ${token.substring(0, 20)}...</p>`;
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<p style="color: red;">登录失败: ${response.message}</p>`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<p style="color: red;">登录错误: ${error.message}</p>`;
            }
        }
        
        async function getBookings() {
            try {
                const response = await axios.get('/bookings/admin/all');
                
                if (response.code === 200) {
                    const bookings = response.data;
                    document.getElementById('bookingsResult').innerHTML = 
                        `<p style="color: green;">获取到 ${bookings.length} 个订单</p>
                         <pre>${JSON.stringify(bookings.slice(0, 3), null, 2)}</pre>`;
                } else {
                    document.getElementById('bookingsResult').innerHTML = 
                        `<p style="color: red;">获取失败: ${response.message}</p>`;
                }
            } catch (error) {
                document.getElementById('bookingsResult').innerHTML = 
                    `<p style="color: red;">获取错误: ${error.message}</p>`;
            }
        }
        
        async function updateStatus() {
            const bookingId = document.getElementById('bookingId').value;
            const status = document.getElementById('status').value;
            
            try {
                const response = await axios.put(`/bookings/${bookingId}/status`, null, {
                    params: { status }
                });
                
                if (response.code === 200) {
                    document.getElementById('updateResult').innerHTML = 
                        `<p style="color: green;">状态更新成功！订单 ${bookingId} 状态已更新为 ${status}</p>`;
                } else {
                    document.getElementById('updateResult').innerHTML = 
                        `<p style="color: red;">更新失败: ${response.message}</p>`;
                }
            } catch (error) {
                document.getElementById('updateResult').innerHTML = 
                    `<p style="color: red;">更新错误: ${error.response?.data?.message || error.message}</p>`;
            }
        }
    </script>
</body>
</html>