# 汽车洗车服务预约系统 - 部署指南

## 系统要求

### 最低配置要求
- **CPU：** 2核心
- **内存：** 4GB RAM
- **存储：** 20GB 可用空间
- **网络：** 稳定的互联网连接

### 推荐配置
- **CPU：** 4核心或更高
- **内存：** 8GB RAM或更高
- **存储：** 50GB SSD
- **网络：** 100Mbps带宽

## 环境准备

### 1. 开发环境部署

#### 1.1 安装Java环境
```bash
# 下载并安装JDK 17
# Windows: 下载Oracle JDK 17或OpenJDK 17
# 配置JAVA_HOME环境变量

# 验证安装
java -version
javac -version
```

#### 1.2 安装Node.js
```bash
# 下载并安装Node.js 18.x
# Windows: 从官网下载安装包

# 验证安装
node -v
npm -v

# 配置npm镜像（可选）
npm config set registry https://registry.npmmirror.com
```

#### 1.3 安装MySQL
```bash
# 下载并安装MySQL 8.0
# Windows: 下载MySQL Installer

# 创建数据库
mysql -u root -p
CREATE DATABASE carwash_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'carwash_user'@'localhost' IDENTIFIED BY 'carwash_password';
GRANT ALL PRIVILEGES ON carwash_db.* TO 'carwash_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 1.4 安装Redis
```bash
# Windows: 下载Redis for Windows
# 或使用Docker运行Redis

# 使用Docker运行Redis
docker run -d --name redis -p 6379:6379 redis:6-alpine

# 验证Redis连接
redis-cli ping
```

### 2. 生产环境部署

#### 2.1 服务器环境
```bash
# Ubuntu 20.04 LTS
sudo apt update
sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git vim htop
```

#### 2.2 安装Docker和Docker Compose
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

## 项目部署

### 1. 获取项目代码

```bash
# 克隆项目（如果使用Git）
git clone <项目仓库地址>
cd 汽车洗车服务预约系统

# 或直接解压项目文件
unzip 汽车洗车服务预约系统.zip
cd 汽车洗车服务预约系统
```

### 2. 后端部署

#### 2.1 开发环境部署

```bash
# 进入后端目录
cd backend

# 配置数据库连接
# 编辑 src/main/resources/application.yml
vim src/main/resources/application.yml
```

**application.yml 配置示例：**
```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/carwash_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: carwash_user
    password: carwash_password
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect

logging:
  level:
    com.carwash: DEBUG
    org.springframework.web.socket: DEBUG
```

```bash
# 编译和运行
mvn clean compile
mvn spring-boot:run

# 或打包运行
mvn clean package
java -jar target/carwash-backend-1.0.0.jar
```

#### 2.2 生产环境部署

**创建Dockerfile：**
```dockerfile
# backend/Dockerfile
FROM openjdk:17-jre-slim

WORKDIR /app

COPY target/carwash-backend-1.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

```bash
# 构建Docker镜像
cd backend
mvn clean package
docker build -t carwash-backend:1.0.0 .
```

### 3. 前端部署

#### 3.1 开发环境部署

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 配置API地址
# 编辑 .env.development
echo "VITE_API_BASE_URL=http://localhost:8080" > .env.development
echo "VITE_WS_BASE_URL=ws://localhost:8080" >> .env.development

# 启动开发服务器
npm run dev
```

#### 3.2 生产环境部署

```bash
# 配置生产环境变量
# 编辑 .env.production
echo "VITE_API_BASE_URL=https://your-domain.com" > .env.production
echo "VITE_WS_BASE_URL=wss://your-domain.com" >> .env.production

# 构建生产版本
npm run build

# 构建Docker镜像
```

**创建Dockerfile：**
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**nginx.conf 配置：**
```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    server {
        listen 80;
        server_name localhost;
        
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        
        location /api/ {
            proxy_pass http://backend:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /ws/ {
            proxy_pass http://backend:8080/ws/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

```bash
# 构建前端镜像
docker build -t carwash-frontend:1.0.0 .
```

## Docker Compose 部署

### 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: carwash-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: carwash_db
      MYSQL_USER: carwash_user
      MYSQL_PASSWORD: carwash_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - carwash-network

  redis:
    image: redis:6-alpine
    container_name: carwash-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - carwash-network

  backend:
    image: carwash-backend:1.0.0
    container_name: carwash-backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/carwash_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: carwash_user
      SPRING_DATASOURCE_PASSWORD: carwash_password
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    networks:
      - carwash-network
    restart: unless-stopped

  frontend:
    image: carwash-frontend:1.0.0
    container_name: carwash-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - carwash-network
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:

networks:
  carwash-network:
    driver: bridge
```

### 部署命令

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

## 数据库初始化

### 创建初始化脚本 init.sql

```sql
-- init.sql
USE carwash_db;

-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    role VARCHAR(20) DEFAULT 'USER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建服务表
CREATE TABLE IF NOT EXISTS services (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    duration INT NOT NULL COMMENT '服务时长（分钟）',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建预约表
CREATE TABLE IF NOT EXISTS bookings (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    service_id BIGINT NOT NULL,
    booking_time DATETIME NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (service_id) REFERENCES services(id)
);

-- 创建订单表
CREATE TABLE IF NOT EXISTS orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    booking_id BIGINT,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    payment_status VARCHAR(20) DEFAULT 'UNPAID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (booking_id) REFERENCES bookings(id)
);

-- 插入初始数据
INSERT INTO users (username, password, email, role) VALUES 
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDa', 'admin@carwash.com', 'ADMIN'),
('user1', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDa', 'user1@example.com', 'USER');

INSERT INTO services (name, description, price, duration) VALUES 
('基础洗车', '外观清洗，内饰简单清理', 30.00, 30),
('精洗服务', '深度清洗，内外全面清理', 80.00, 60),
('豪华套餐', '全方位清洗+打蜡+内饰深度清理', 150.00, 120);
```

## SSL证书配置

### 1. 获取SSL证书

```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot
sudo certbot certonly --standalone -d your-domain.com
```

### 2. Nginx SSL配置

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://backend:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /ws/ {
        proxy_pass http://backend:8080/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 监控和日志

### 1. 应用监控

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - carwash-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - carwash-network

volumes:
  grafana_data:
```

### 2. 日志配置

**logback-spring.xml：**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/carwash.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/carwash.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
    </root>
    
    <logger name="com.carwash" level="DEBUG"/>
    <logger name="org.springframework.web.socket" level="DEBUG"/>
</configuration>
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"
DB_NAME="carwash_db"

mkdir -p $BACKUP_DIR

# 备份数据库
docker exec carwash-mysql mysqldump -u root -proot_password $DB_NAME > $BACKUP_DIR/carwash_db_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/carwash_db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "carwash_db_*.sql.gz" -mtime +7 -delete

echo "Backup completed: carwash_db_$DATE.sql.gz"
EOF

chmod +x backup.sh

# 设置定时备份
crontab -e
# 添加：0 2 * * * /path/to/backup.sh
```

### 2. 数据恢复

```bash
# 恢复数据库
gunzip carwash_db_20231102_020000.sql.gz
docker exec -i carwash-mysql mysql -u root -proot_password carwash_db < carwash_db_20231102_020000.sql
```

## 性能优化

### 1. 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_bookings_user_id ON bookings(user_id);
CREATE INDEX idx_bookings_booking_time ON bookings(booking_time);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);

-- 优化MySQL配置
-- 在my.cnf中添加：
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
max_connections = 200
query_cache_size = 64M
```

### 2. Redis优化

```bash
# Redis配置优化
echo "maxmemory 512mb" >> /etc/redis/redis.conf
echo "maxmemory-policy allkeys-lru" >> /etc/redis/redis.conf
echo "save 900 1" >> /etc/redis/redis.conf
echo "save 300 10" >> /etc/redis/redis.conf
echo "save 60 10000" >> /etc/redis/redis.conf
```

### 3. 应用优化

```yaml
# application-prod.yml
server:
  tomcat:
    max-threads: 200
    min-spare-threads: 10
    max-connections: 8192

spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

## 故障排除

### 1. 常见问题

#### 数据库连接失败
```bash
# 检查MySQL服务状态
docker logs carwash-mysql

# 检查网络连接
docker exec carwash-backend ping mysql

# 检查配置
docker exec carwash-backend env | grep SPRING_DATASOURCE
```

#### WebSocket连接失败
```bash
# 检查后端日志
docker logs carwash-backend | grep WebSocket

# 检查Nginx配置
nginx -t

# 测试WebSocket连接
wscat -c ws://localhost:8080/ws/order-status?userId=1
```

#### 前端无法访问API
```bash
# 检查Nginx配置
docker logs carwash-frontend

# 检查代理配置
curl -I http://localhost/api/health

# 检查CORS配置
```

### 2. 日志分析

```bash
# 查看应用日志
docker logs -f carwash-backend
docker logs -f carwash-frontend

# 查看系统资源
docker stats

# 查看网络连接
netstat -tulpn | grep :8080
```

## 安全加固

### 1. 防火墙配置

```bash
# Ubuntu UFW配置
sudo ufw enable
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 3306/tcp
sudo ufw deny 6379/tcp
```

### 2. 应用安全

```yaml
# 生产环境安全配置
spring:
  security:
    require-ssl: true
  
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: never
```

### 3. 容器安全

```dockerfile
# 使用非root用户运行
FROM openjdk:17-jre-slim
RUN addgroup --system carwash && adduser --system --group carwash
USER carwash
```

## 部署检查清单

### 部署前检查
- [ ] 服务器资源充足
- [ ] 域名DNS解析正确
- [ ] SSL证书有效
- [ ] 数据库备份完成
- [ ] 配置文件正确

### 部署后检查
- [ ] 所有服务正常启动
- [ ] 数据库连接正常
- [ ] Redis缓存工作正常
- [ ] WebSocket连接正常
- [ ] API接口响应正常
- [ ] 前端页面加载正常
- [ ] 日志记录正常
- [ ] 监控系统工作正常

### 性能测试
- [ ] 负载测试通过
- [ ] 并发测试通过
- [ ] WebSocket压力测试通过
- [ ] 数据库性能测试通过

---

**文档版本：** 1.0  
**最后更新：** 2025-11-02  
**适用版本：** 汽车洗车服务预约系统 v1.0