# 支付系统设计：网关、回调与审计

## 设计目标
- 标准化支付网关接入，统一请求与响应模型。
- 完整覆盖支付生命周期：创建、查询、回调、退款、超时取消。
- 引入审计日志，确保关键事件可追溯、可定位、可分析。
- 保证幂等与订单同步，避免重复扣款或状态错乱。

## 关键组件
- `PaymentGateway` 接口：统一网关操作（创建、查询、退款）。
- `PaymentServiceImpl`：支付业务编排，负责权限校验、状态流转、调用网关、更新订单、写入审计。
- `CallbackSignatureVerifier`：统一的回调验签组件，支持 WeChat、Alipay 等。
- `PaymentAudit` + `PaymentAuditMapper`：审计实体与数据访问层。
  - 表：`payment_audit`（MySQL），包含事件类型、状态、金额、操作人、原始数据等。

## 数据库设计（MySQL）
表：`payment_audit`
- 主键：`id` BIGINT AUTO_INCREMENT
- 业务键：`payment_no`、`order_no`
- 字段：`event_type`、`status`、`payment_method`、`amount`、`operator_id`、`message`、`raw_data`、`created_at`
- 索引：`idx_payment_no`、`idx_order_no`、`idx_event_type`、`idx_created_at`
- 脚本：`sql/2025-11-08__create_payment_audit.sql`

## 审计事件定义
- `CREATE`：创建支付记录（入库后）。
- `CALL_GATEWAY`：调用网关创建支付（返回二维码/URL等）。
- `QUERY_STATUS`：主动查询第三方状态（待支付时）。
- `STATUS_CHANGE`：第三方查询导致状态变化（如从 pending → paid）。
- `CALLBACK_VERIFIED`：回调验签通过（记录原始参数）。
- `CALLBACK_UPDATE`：回调更新支付为 `paid` 并同步订单。
- `REFUND_REQUEST`：发起退款请求（记录金额与操作人）。
- `REFUND_SUCCESS`：退款成功（更新退款单、支付状态）。
- `REFUND_FAILED`：退款失败（记录失败原因）。
- `CANCEL_EXPIRED`：超时自动取消（批处理）。

## 服务流程与幂等
1. `createPayment`：
   - 校验订单与权限，检查支付状态。
   - `pending`幂等：已有未过期的待支付单直接返回；否则新建。
   - 写入审计：`CREATE` → `CALL_GATEWAY`。
2. `queryPaymentStatus`：
   - 对 `pending` 状态调用网关查询，若状态变化则更新支付与订单。
   - 写入审计：`QUERY_STATUS` → 若变更则 `STATUS_CHANGE`。
3. `handlePaymentCallback`：
   - 验签（失败直接拒绝）。
   - 根据回调参数定位支付单，更新为 `paid`，同步订单。
   - 写入审计：`CALLBACK_VERIFIED` → `CALLBACK_UPDATE`。
4. `processRefund`：
   - 校验可退条件，生成退款单号，插入退款记录。
   - 调用网关退款 API，更新退款状态与支付状态。
   - 写入审计：`REFUND_REQUEST` → `REFUND_SUCCESS`/`REFUND_FAILED`。
5. `cancelExpiredPayments`：
   - 批量取消过期的 `pending` 支付，更新订单。
   - 写入审计：`CANCEL_EXPIRED`。

## 订单同步策略
- 支付成功：`Booking.paymentStatus` → `paid`，回写 `paymentMethod`、`paidAt`。
- 退款成功：`Booking.paymentStatus` → `refunded`（如业务需要）。
- 取消过期：`Booking.paymentStatus` → `cancelled`（如业务需要）。

## 监控与度量
- `PaymentMonitor`：记录创建/查询/失败等轻量指标（可选注入，不强依赖）。
- 审计与监控互补：监控用于趋势指标，审计用于事件追溯。

## 实施与测试
- 已在 `PaymentServiceImpl` 关键节点插入审计写入，空注入容忍（Mapper 为 `@Autowired(required=false)`）。
- 单测：`PaymentServiceImplVirtualGatewayTest` 通过，未破坏原有流程。
- 接口文档：`payment-gateway.md` 与本设计文档协同描述。

## 运维与扩展
- 审计表按天/周归档与冷热分层（后续计划）。
- 审计事件可扩展 `fraud_detected`、`manual_adjustment` 等。
- 可接入 ELK/ClickHouse 进行审计分析与可视化。

## 附录
- 相关代码：`PaymentServiceImpl`、`PaymentAudit`、`PaymentAuditMapper`、`CallbackSignatureVerifier`。
- 脚本位置：`sql/2025-11-08__create_payment_audit.sql`。
- 约束：遵循 MySQL 设计与开发按计划顺序推进、完成后更新计划书文档。