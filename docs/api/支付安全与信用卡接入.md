# 支付安全与信用卡通道接入（更新记录）

更新日期：2025-11-08  
适用版本：carwash-reservation-system 1.0.0（dev、payment 配置）

## 变更概览
- 新增前端「信用卡」支付选项与表单（`src/views/Payment.vue`）。
- 前端新增获取 RSA 公钥接口调用（`src/api/payment.js#getPublicKey`）。
- 前端在发起 `credit_card` 支付时对敏感信息进行 RSA-OAEP 加密并传入 `securePayload`。
- 后端新增公钥接口 `GET /api/payment/security/public-key`，并接入 `CreditCardGateway` 执行解密与校验。
- 保持原有微信/支付宝通道不受影响，统一返回 `PaymentResponse` 字段。
- 数据库设计仍采用 MySQL，本次变更不涉及表结构调整。

## 前端改动要点
- 路由：`/payment/:orderNo?`（需登录）。
- 表单字段：持卡人、卡号、有效期 `MM/YY`、CVV、一次性验证码（OTP）。
- 校验：本地 Luhn 校验（卡号），有效期与 CVV 格式校验。
- 加密：
  - 通过 `GET /api/payment/security/public-key` 获取 PEM 公钥。
  - 使用 WebCrypto 导入 `RSA-OAEP` 公钥，`SHA-256` 哈希。
  - 将 `cardholder/cardNumber/expiry/cvv/otp` 加密后作为 `securePayload.encryptedCard` 发送。
- 请求示例：

```json
POST /api/payment/create
{
  "orderNo": "ORD303",
  "method": "credit_card",
  "securePayload": {
    "encryptedCard": "<Base64-RSA-OAEP>",
    "deviceInfo": {
      "ua": "Mozilla/5.0 ...",
      "screen": "1920x1080",
      "language": "zh-CN"
    },
    "otp": "123456"
  }
}
```

## 后端接口
- `GET /api/payment/security/public-key`
  - 说明：返回 RSA 公钥（PEM 或文本），需认证。
  - 响应：`text/plain`（公钥字符串）。

- `POST /api/payment/create`
  - 说明：统一创建支付，`method` 支持 `wechat_pay | alipay | credit_card`。
  - 请求：见前端示例。
  - 响应示例：

```json
{
  "status": "SUCCESS",
  "paymentNo": "PAY202511080001",
  "payUrl": null,
  "qrCode": null,
  "errorMessage": null
}
```

## 安全与校验
- 信用卡卡号在网关内执行 Luhn 校验与格式检查。
- `RSA-OAEP` 解密敏感载荷后进行字段完整性与 OTP 验证（demo 环节）。
- 后续可接入 3-D Secure（3DS）与更严格风控策略。

## 验证步骤
1. 启动后端（端口 `8080`），启动前端（端口 `3000`）。
2. 访问 `http://localhost:3000/auto-test-login.html`，点击「运行所有测试」或执行管理员登录（`admin/admin123`）。
3. 打开 `http://localhost:3000/#/payment/ORD303`。
4. 选择「信用卡」，填写测试信息（如：`4111 1111 1111 1111`、`12/28`、`123`）。
5. 点击支付，检查网络请求包含 `GET /api/payment/security/public-key` 与 `POST /api/payment/create`（带 `securePayload`）。
6. 观察支付结果提示与后端日志，确认 `PaymentResponse.status` 为 `SUCCESS` 或正确的失败原因。

## 影响评估
- 数据库：无结构变更，保持 MySQL 方案。
- 接口：新增公钥接口；支付创建接口兼容新增通道。
- 前端：新增支付方式与表单，不影响已有支付方式。

## 后续计划
- 接入真实发卡机构通道与 3DS 短信网关。
- 支持卡号掩码与保存最近一次支付信息（非敏感）。
- 完善失败重试与异常提示文案。