# 汽车洗车服务预约系统 - 缺失功能清单

**文档版本：** v1.0  
**更新时间：** 2025年1月17日  
**状态：** 待开发  

---

## 📋 功能分类概览

| 优先级 | 功能数量 | 预计总周期 | 商业价值 |
|--------|----------|------------|----------|
| 🔴 极高 | 3个 | 6-8周 | 极高 |
| 🟡 中高 | 4个 | 8-10周 | 高 |
| 🟢 低 | 3个 | 7-9周 | 中等 |

---

## 🔴 极高优先级功能

### 1. 💳 支付系统集成

**功能描述：**
完整的在线支付解决方案，支持主流支付方式，确保交易安全和用户体验。

**详细需求：**
- **支付方式集成**
  - 微信支付（扫码支付、H5支付）
  - 支付宝（网页支付、手机支付）
  - 银联云闪付
  - 信用卡支付（可选）

- **支付流程管理**
  - 订单支付状态实时同步
  - 支付超时自动取消
  - 支付失败重试机制
  - 支付成功确认通知

- **安全机制**
  - 支付密钥加密存储
  - 支付回调验签
  - 防重复支付
  - 支付日志审计

- **退款系统**
  - 全额退款
  - 部分退款
  - 退款状态跟踪
  - 退款到账通知

**技术实现：**
```java
// 支付服务接口
public interface PaymentService {
    PaymentResult createPayment(PaymentRequest request);
    PaymentStatus queryPaymentStatus(String orderNo);
    RefundResult processRefund(RefundRequest request);
    void handlePaymentCallback(PaymentCallback callback);
}

// 支付配置
@ConfigurationProperties(prefix = "payment")
public class PaymentConfig {
    private WechatPayConfig wechat;
    private AlipayConfig alipay;
    private UnionPayConfig unionpay;
}
```

**数据库设计：**
```sql
-- 支付记录表
CREATE TABLE payments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(32) NOT NULL,
    payment_no VARCHAR(64) UNIQUE,
    user_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    paid_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 退款记录表
CREATE TABLE refunds (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    payment_id BIGINT NOT NULL,
    refund_no VARCHAR(64) UNIQUE,
    amount DECIMAL(10,2) NOT NULL,
    reason VARCHAR(200),
    status VARCHAR(20) DEFAULT 'pending',
    refunded_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**开发周期：** 2-3周  
**风险评估：** 🟡 中等（第三方接口集成复杂度）  
**商业价值：** 🔴 极高（商业闭环必需）  

**当前进度（2025-11-08）**：
- ✅ 支付回调统一验签完成（`CallbackSignatureVerifier` 已集成）
- ✅ 支付审计日志上线（`PaymentAudit`、`PaymentAuditMapper`、`payment_audit` 表）
- ✅ 在 `PaymentServiceImpl` 关键流程写入审计（创建/查询/回调/退款/超时）
- ✅ 设计文档补充（`docs/api/支付系统设计-网关回调与审计.md`）
- ✅ 单元测试通过（`PaymentServiceImplVirtualGatewayTest`）
- 🚀 阶段结论：支付系统集成与订单状态同步已完成第一阶段目标

---

### 2. 🔧 注册功能API集成

**功能描述：**
完善用户注册流程，包括后端API集成、数据验证和用户体验优化。

**详细需求：**
- **注册API实现**
  - 用户名唯一性验证
  - 手机号验证码发送
  - 邮箱验证（可选）
  - 密码强度验证

- **数据验证**
  - 前端实时验证
  - 后端数据校验
  - 重复注册检测
  - 恶意注册防护

- **用户体验**
  - 注册进度提示
  - 错误信息友好显示
  - 注册成功自动登录
  - 欢迎引导流程

**技术实现：**
```javascript
// 前端注册API调用
const handleRegister = async () => {
  try {
    const response = await authApi.register(registerForm)
    if (response.success) {
      ElMessage.success('注册成功！正在为您自动登录...')
      // 自动登录
      await authApi.login({
        username: registerForm.username,
        password: registerForm.password
      })
      router.push('/')
    }
  } catch (error) {
    ElMessage.error(error.message)
  }
}
```

```java
// 后端注册服务
@Service
public class UserServiceImpl implements UserService {
    @Override
    @Transactional
    public void register(RegisterRequest request) {
        // 验证用户名唯一性
        if (existsByUsername(request.getUsername())) {
            throw new BusinessException("用户名已存在");
        }
        
        // 验证手机号唯一性
        if (existsByPhone(request.getPhone())) {
            throw new BusinessException("手机号已注册");
        }
        
        // 创建用户
        User user = new User();
        BeanUtils.copyProperties(request, user);
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setRole("user");
        user.setStatus(1);
        
        userMapper.insert(user);
    }
}
```

**开发周期：** 1周  
**风险评估：** 🟢 低  
**商业价值：** 🔴 极高（用户注册流程完整性）  

---

### 3. 🔄 订单状态实时同步

**功能描述：**
实现订单状态的实时更新和同步，确保用户能够及时了解订单进展。

**详细需求：**
- **状态同步机制**
  - WebSocket实时推送
  - 定时轮询备用方案
  - 状态变更通知
  - 离线状态缓存

- **状态管理**
  - 订单状态流转控制
  - 状态变更日志记录
  - 异常状态处理
  - 状态回滚机制

**技术实现：**
```javascript
// 前端WebSocket连接
import { useOrderSync } from '@/utils/orderSync'

export default {
  setup() {
    const { connectWebSocket, orders } = useOrderSync()
    
    onMounted(() => {
      connectWebSocket()
    })
    
    return { orders }
  }
}
```

```java
// 后端WebSocket配置
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new OrderStatusHandler(), "/ws/orders")
                .setAllowedOrigins("*");
    }
}
```

**开发周期：** 1-2周  
**风险评估：** 🟡 中等（WebSocket连接稳定性）  
**商业价值：** 🔴 高（用户体验提升）  

---

## 🟡 中高优先级功能

### 4. 🎖️ 会员系统

**功能描述：**
完整的会员管理系统，包括会员等级、积分体系、权益管理等。

**详细需求：**
- **会员等级体系**
  - 普通会员、银卡会员、金卡会员、钻石会员
  - 等级升级条件（消费金额、订单数量）
  - 等级权益差异化
  - 等级保级机制

- **积分系统**
  - 消费积分规则
  - 签到积分奖励
  - 积分兑换商品
  - 积分过期机制

- **会员权益**
  - 专属折扣
  - 优先预约
  - 生日特权
  - 专属客服

**数据库设计：**
```sql
-- 会员等级表
CREATE TABLE member_levels (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    level_name VARCHAR(20) NOT NULL,
    min_points INT NOT NULL,
    discount_rate DECIMAL(3,2) DEFAULT 1.00,
    privileges JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户积分表
CREATE TABLE user_points (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    total_points INT DEFAULT 0,
    available_points INT DEFAULT 0,
    level_id BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 积分记录表
CREATE TABLE point_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    points INT NOT NULL,
    type VARCHAR(20) NOT NULL, -- earn, spend, expire
    source VARCHAR(50), -- order, signin, exchange
    description VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**开发周期：** 2周  
**风险评估：** 🟢 低  
**商业价值：** 🔴 高（用户粘性提升）  

---

### 5. 🔔 消息通知系统

**功能描述：**
多渠道消息通知系统，包括短信、邮件、站内消息等。

**详细需求：**
- **通知渠道**
  - 短信通知（阿里云SMS）
  - 邮件通知（SMTP）
  - 站内消息
  - 微信模板消息

- **通知场景**
  - 预约确认通知
  - 服务开始提醒
  - 支付成功通知
  - 订单完成通知
  - 营销活动推送

- **通知管理**
  - 通知模板管理
  - 发送频率控制
  - 用户偏好设置
  - 发送状态跟踪

**技术实现：**
```java
// 通知服务接口
public interface NotificationService {
    void sendSMS(String phone, String template, Map<String, Object> params);
    void sendEmail(String email, String subject, String content);
    void sendInAppMessage(Long userId, String title, String content);
    void sendWechatMessage(String openId, String templateId, Map<String, Object> data);
}

// 通知配置
@ConfigurationProperties(prefix = "notification")
public class NotificationConfig {
    private SmsConfig sms;
    private EmailConfig email;
    private WechatConfig wechat;
}
```

**开发周期：** 1-2周  
**风险评估：** 🟢 低  
**商业价值：** 🟡 中高（用户体验提升）  

---

### 6. 📈 数据分析与报表

**功能描述：**
业务数据分析和可视化报表系统，支持运营决策。

**详细需求：**
- **业务指标分析**
  - 订单量统计
  - 收入分析
  - 用户增长分析
  - 服务热度排行

- **用户行为分析**
  - 用户访问路径
  - 转化率分析
  - 用户留存率
  - 用户价值分析

- **可视化报表**
  - 实时数据大屏
  - 定期业务报告
  - 自定义图表
  - 数据导出功能

**技术实现：**
```javascript
// 前端图表组件
import * as echarts from 'echarts'

const initCharts = () => {
  const chart = echarts.init(chartRef.value)
  chart.setOption({
    title: { text: '订单趋势分析' },
    xAxis: { type: 'category', data: dates },
    yAxis: { type: 'value' },
    series: [{
      data: orderCounts,
      type: 'line',
      smooth: true
    }]
  })
}
```

```java
// 后端统计服务
@Service
public class StatisticsService {
    public OrderStatistics getOrderStatistics(LocalDate startDate, LocalDate endDate) {
        // 查询订单统计数据
        return OrderStatistics.builder()
            .totalOrders(bookingMapper.countByDateRange(startDate, endDate))
            .totalRevenue(bookingMapper.sumRevenueByDateRange(startDate, endDate))
            .build();
    }
}
```

**开发周期：** 2-3周  
**风险评估：** 🟡 中等（数据处理复杂度）  
**商业价值：** 🟡 中高（运营决策支持）  

---

### 7. 🤖 AI智能客服系统

**功能描述：**
基于AI的智能客服系统，提供24小时自动客服支持。

**详细需求：**
- **智能对话**
  - 自然语言理解
  - 多轮对话支持
  - 常见问题自动回答
  - 人工客服转接

- **智能功能**
  - 预约意图识别
  - 智能推荐服务
  - 情感分析
  - 用户画像分析

- **管理功能**
  - 对话记录管理
  - 知识库维护
  - 回答质量评估
  - 客服效果分析

**技术实现：**
```java
// AI客服服务
@Service
public class AICustomerService {
    @Autowired
    private TongyiQianwenClient aiClient;
    
    public ChatResponse chat(String userId, String message) {
        // 调用通义千问API
        String response = aiClient.chat(message);
        
        // 保存对话记录
        saveChatRecord(userId, message, response);
        
        return ChatResponse.builder()
            .message(response)
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

**开发周期：** 3-4周  
**风险评估：** 🔴 高（AI技术集成复杂度）  
**商业价值：** 🟡 中高（技术创新亮点）  

---

## 🟢 低优先级功能

### 8. 📱 移动端应用

**功能描述：**
开发移动端应用，包括微信小程序和移动APP。

**详细需求：**
- **微信小程序**
  - 核心功能移植
  - 微信支付集成
  - 小程序特有功能
  - 微信生态集成

- **移动APP**
  - 跨平台开发（uni-app）
  - 原生功能调用
  - 推送通知
  - 离线功能支持

**开发周期：** 4-6周  
**风险评估：** 🟡 中等（多平台适配）  
**商业价值：** 🟡 中等（用户覆盖扩展）  

---

### 9. 🏪 多门店管理

**功能描述：**
支持多门店运营管理，包括门店信息、服务配置、订单分配等。

**详细需求：**
- **门店管理**
  - 门店信息维护
  - 服务项目配置
  - 营业时间设置
  - 门店员工管理

- **订单分配**
  - 就近门店推荐
  - 门店容量管理
  - 跨店服务支持
  - 门店业绩统计

**开发周期：** 3-4周  
**风险评估：** 🟡 中等（业务逻辑复杂度）  
**商业价值：** 🟢 中等（业务规模扩展）  

---

### 10. 🎁 营销活动系统

**功能描述：**
营销活动管理系统，支持优惠券、促销活动、会员营销等。

**详细需求：**
- **优惠券系统**
  - 优惠券创建和发放
  - 使用规则设置
  - 优惠券核销
  - 使用统计分析

- **促销活动**
  - 限时折扣
  - 满减活动
  - 新用户优惠
  - 节日特惠

**开发周期：** 2-3周  
**风险评估：** 🟢 低  
**商业价值：** 🟡 中等（用户获取和留存）  

---

## 📊 开发优先级建议

### 第一阶段（立即开始）
1. **支付系统集成** - 确保商业闭环
2. **注册功能完善** - 完善用户流程
3. **订单状态同步** - 提升用户体验

### 第二阶段（1个月后）
1. **会员系统** - 提升用户粘性
2. **消息通知系统** - 优化用户体验

### 第三阶段（2个月后）
1. **数据分析报表** - 支持运营决策
2. **AI智能客服** - 技术创新亮点

### 第四阶段（3个月后）
1. **移动端应用** - 扩展用户覆盖
2. **多门店管理** - 支持业务扩展
3. **营销活动系统** - 增强营销能力

---

## 📋 总结

**总计缺失功能：** 10个  
**预计总开发周期：** 21-27周  
**建议分阶段实施：** 4个阶段  
**核心功能优先：** 支付系统、会员系统、通知系统  

**关键建议：**
1. 优先完成商业闭环相关功能
2. 分阶段实施，控制开发风险
3. 重点关注用户体验提升
4. 预留技术创新展示空间

---

*本清单将根据开发进展定期更新，确保项目按计划推进。*