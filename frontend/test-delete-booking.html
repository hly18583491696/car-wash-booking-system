<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•åˆ é™¤è®¢å•åŠŸèƒ½</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      border-bottom: 3px solid #409EFF;
      padding-bottom: 10px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .section h2 {
      color: #409EFF;
      margin-top: 0;
    }
    
    button {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #66B1FF;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
    }
    
    button.danger {
      background: #F56C6C;
    }
    
    button.danger:hover {
      background: #F78989;
    }
    
    button.success {
      background: #67C23A;
    }
    
    button.success:hover {
      background: #85CE61;
    }
    
    input, select {
      padding: 8px 12px;
      border: 1px solid #DCDFE6;
      border-radius: 4px;
      font-size: 14px;
      margin: 5px;
    }
    
    .log {
      background: #2d2d2d;
      color: #f0f0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .log-entry {
      margin: 5px 0;
      line-height: 1.6;
    }
    
    .log-entry.success { color: #67C23A; }
    .log-entry.error { color: #F56C6C; }
    .log-entry.info { color: #409EFF; }
    .log-entry.warning { color: #E6A23C; }
    
    .booking-list {
      display: grid;
      gap: 15px;
      margin-top: 15px;
    }
    
    .booking-item {
      background: white;
      border: 1px solid #EBEEF5;
      padding: 15px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .booking-item:hover {
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      transform: translateX(5px);
    }
    
    .booking-info {
      flex: 1;
    }
    
    .booking-info h3 {
      margin: 0 0 10px 0;
      color: #303133;
    }
    
    .booking-info p {
      margin: 5px 0;
      color: #606266;
      font-size: 14px;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status.pending { background: #FDF6EC; color: #E6A23C; }
    .status.confirmed { background: #E1F3D8; color: #67C23A; }
    .status.completed { background: #D9ECFF; color: #409EFF; }
    .status.cancelled { background: #FEF0F0; color: #F56C6C; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #409EFF;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #606266;
      font-size: 14px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #303133;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª åˆ é™¤è®¢å•åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="section">
      <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
      <div class="stats">
        <div class="stat-card">
          <h3>æ€»è®¢å•æ•°</h3>
          <div class="value" id="totalCount">0</div>
        </div>
        <div class="stat-card" style="border-left-color: #67C23A;">
          <h3>æ•°æ®åº“ä¸­çš„è®¢å•</h3>
          <div class="value" id="dbCount">0</div>
        </div>
        <div class="stat-card" style="border-left-color: #F56C6C;">
          <h3>å·²åˆ é™¤çš„è®¢å•</h3>
          <div class="value" id="deletedCount">0</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2>ğŸ”§ æ“ä½œæ§åˆ¶</h2>
      <button class="success" onclick="loadBookings()">ğŸ“¥ åŠ è½½è®¢å•åˆ—è¡¨</button>
      <button onclick="checkDatabaseStatus()">ğŸ” æ£€æŸ¥æ•°æ®åº“çŠ¶æ€</button>
      <button class="danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="section">
      <h2>ğŸ“‹ è®¢å•åˆ—è¡¨</h2>
      <div id="bookingList" class="booking-list">
        <p style="color: #909399;">ç‚¹å‡»"åŠ è½½è®¢å•åˆ—è¡¨"æŸ¥çœ‹æ•°æ®</p>
      </div>
    </div>
    
    <div class="section">
      <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
      <div id="logContainer" class="log">
        <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080'
    let bookings = []
    
    // æ—¥å¿—è®°å½•
    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer')
      const timestamp = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.textContent = `[${timestamp}] ${message}`
      logContainer.appendChild(entry)
      logContainer.scrollTop = logContainer.scrollHeight
      console.log(`[${type.toUpperCase()}] ${message}`)
    }
    
    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>'
      log('æ—¥å¿—å·²æ¸…ç©º', 'info')
    }
    
    // è·å–Token
    function getToken() {
      const token = localStorage.getItem('token')
      const tokenType = localStorage.getItem('tokenType') || 'Bearer'
      return token ? `${tokenType} ${token}` : null
    }
    
    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadBookings() {
      log('å¼€å§‹åŠ è½½è®¢å•åˆ—è¡¨...', 'info')
      
      try {
        const token = getToken()
        if (!token) {
          log('æœªæ‰¾åˆ°è®¤è¯Tokenï¼Œè¯·å…ˆç™»å½•', 'error')
          alert('è¯·å…ˆåœ¨ä¸»é¡µé¢ç™»å½•')
          return
        }
        
        const response = await fetch(`${API_BASE_URL}/bookings/admin/all`, {
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        })
        
        log(`è¯·æ±‚çŠ¶æ€: ${response.status} ${response.statusText}`, 'info')
        
        const result = await response.json()
        log(`å“åº”æ•°æ®: ${JSON.stringify(result)}`, 'info')
        
        if (result.code === 200) {
          bookings = result.data || []
          log(`æˆåŠŸåŠ è½½ ${bookings.length} æ¡è®¢å•`, 'success')
          displayBookings()
          updateStats()
        } else {
          log(`åŠ è½½å¤±è´¥: ${result.message}`, 'error')
        }
      } catch (error) {
        log(`åŠ è½½è®¢å•å¼‚å¸¸: ${error.message}`, 'error')
        console.error(error)
      }
    }
    
    // æ˜¾ç¤ºè®¢å•åˆ—è¡¨
    function displayBookings() {
      const container = document.getElementById('bookingList')
      
      if (bookings.length === 0) {
        container.innerHTML = '<p style="color: #909399;">æš‚æ— è®¢å•æ•°æ®</p>'
        return
      }
      
      container.innerHTML = bookings.map(booking => `
        <div class="booking-item">
          <div class="booking-info">
            <h3>è®¢å• #${booking.id} - ${booking.serviceName || 'æœªçŸ¥æœåŠ¡'}</h3>
            <p><strong>è®¢å•å·:</strong> ${booking.orderNo}</p>
            <p><strong>çŠ¶æ€:</strong> <span class="status ${booking.status}">${booking.status}</span></p>
            <p><strong>é¢„çº¦æ—¶é—´:</strong> ${booking.bookingDate} ${booking.bookingTime}</p>
            <p><strong>é‡‘é¢:</strong> Â¥${booking.totalPrice}</p>
          </div>
          <div>
            <button class="danger" onclick="deleteBooking(${booking.id}, '${booking.orderNo}')">
              ğŸ—‘ï¸ åˆ é™¤
            </button>
          </div>
        </div>
      `).join('')
    }
    
    // åˆ é™¤è®¢å•
    async function deleteBooking(bookingId, orderNo) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¢å• ${orderNo} å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼`)) {
        log('ç”¨æˆ·å–æ¶ˆåˆ é™¤', 'warning')
        return
      }
      
      log(`å¼€å§‹åˆ é™¤è®¢å• ID: ${bookingId}, è®¢å•å·: ${orderNo}`, 'info')
      
      try {
        const token = getToken()
        if (!token) {
          log('æœªæ‰¾åˆ°è®¤è¯Token', 'error')
          return
        }
        
        const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        })
        
        log(`åˆ é™¤è¯·æ±‚çŠ¶æ€: ${response.status} ${response.statusText}`, 'info')
        
        const result = await response.json()
        log(`åˆ é™¤å“åº”: ${JSON.stringify(result)}`, 'info')
        
        if (result.code === 200) {
          log(`âœ… è®¢å•åˆ é™¤æˆåŠŸ: ${orderNo}`, 'success')
          
          // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
          log('é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨...', 'info')
          await loadBookings()
          
          // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
          await checkDatabaseStatus()
        } else {
          log(`åˆ é™¤å¤±è´¥: ${result.message}`, 'error')
          alert(`åˆ é™¤å¤±è´¥: ${result.message}`)
        }
      } catch (error) {
        log(`åˆ é™¤è®¢å•å¼‚å¸¸: ${error.message}`, 'error')
        console.error(error)
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`)
      }
    }
    
    // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    async function checkDatabaseStatus() {
      log('æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...', 'info')
      
      try {
        const token = getToken()
        if (!token) {
          log('æœªæ‰¾åˆ°è®¤è¯Token', 'error')
          return
        }
        
        // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¸€ä¸ªä¸“é—¨çš„æ£€æŸ¥æ¥å£
        // æš‚æ—¶ä½¿ç”¨åŒæ­¥æ£€æŸ¥æ¥å£
        const response = await fetch(`${API_BASE_URL}/bookings/admin/sync-check`, {
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        })
        
        const result = await response.json()
        
        if (result.code === 200) {
          const data = result.data
          log(`æ•°æ®åº“æ£€æŸ¥ç»“æœ:`, 'success')
          log(`- æ€»è®¢å•æ•°: ${data.totalBookings}`, 'info')
          log(`- çŠ¶æ€åˆ†å¸ƒ: ${JSON.stringify(data.statusDistribution)}`, 'info')
          log(`- åŒæ­¥æ—¶é—´: ${data.lastSyncTime}`, 'info')
        } else {
          log(`æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${result.message}`, 'error')
        }
      } catch (error) {
        log(`æ•°æ®åº“æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error')
        console.error(error)
      }
    }
    
    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      document.getElementById('totalCount').textContent = bookings.length
      document.getElementById('dbCount').textContent = bookings.length
      // å·²åˆ é™¤çš„è®¢å•ä¸ä¼šåœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼Œæ‰€ä»¥è¿™é‡Œä¸º0
      document.getElementById('deletedCount').textContent = '0'
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è®¢å•
    window.onload = function() {
      log('é¡µé¢åŠ è½½å®Œæˆ', 'success')
      log('å‡†å¤‡åŠ è½½è®¢å•åˆ—è¡¨...', 'info')
      setTimeout(() => {
        loadBookings()
      }, 500)
    }
  </script>
</body>
</html>
