<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket APIæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
            color: #555;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input, select {
            width: 200px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        .log-entry.info {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        .log-entry.success {
            background-color: #e8f5e8;
            border-left: 3px solid #4caf50;
        }
        .log-entry.error {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
        }
        .log-entry.websocket {
            background-color: #fff3e0;
            border-left: 3px solid #ff9800;
        }
        .timestamp {
            color: #666;
            font-size: 11px;
        }
        .api-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .api-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .api-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket APIæµ‹è¯•å·¥å…·</h1>
        
        <!-- WebSocketè¿æ¥çŠ¶æ€ -->
        <div id="connectionStatus" class="status disconnected">
            WebSocketæœªè¿æ¥
        </div>
        
        <!-- WebSocketè¿æ¥æ§åˆ¶ -->
        <div class="test-section">
            <h3>ğŸ”Œ WebSocketè¿æ¥ç®¡ç†</h3>
            <div class="form-group">
                <label>ç”¨æˆ·ID:</label>
                <input type="number" id="userId" value="1" min="1">
            </div>
            <button id="connectBtn" onclick="connectWebSocket()">è¿æ¥WebSocket</button>
            <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>æ–­å¼€è¿æ¥</button>
            <button onclick="sendPing()">å‘é€å¿ƒè·³</button>
        </div>
        
        <!-- APIæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª WebSocket APIæµ‹è¯•</h3>
            
            <!-- å¥åº·æ£€æŸ¥ -->
            <div style="margin-bottom: 20px;">
                <h4>å¥åº·æ£€æŸ¥</h4>
                <button onclick="testHealthCheck()">æ£€æŸ¥WebSocketæœåŠ¡çŠ¶æ€</button>
                <button onclick="testConnectionCount()">è·å–è¿æ¥æ•°</button>
                <div id="healthResult" class="api-result" style="display: none;"></div>
            </div>
            
            <!-- è®¢å•çŠ¶æ€æ¨é€æµ‹è¯• -->
            <div>
                <h4>è®¢å•çŠ¶æ€æ¨é€æµ‹è¯•</h4>
                <div class="form-group">
                    <label>ç›®æ ‡ç”¨æˆ·ID:</label>
                    <input type="number" id="targetUserId" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>è®¢å•ID:</label>
                    <input type="number" id="orderId" value="1001" min="1">
                </div>
                <div class="form-group">
                    <label>è®¢å•å·:</label>
                    <input type="text" id="orderNo" value="ORDER-2025-001">
                </div>
                <div class="form-group">
                    <label>åŸçŠ¶æ€:</label>
                    <select id="oldStatus">
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="confirmed">å·²ç¡®è®¤</option>
                        <option value="in_progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ–°çŠ¶æ€:</label>
                    <select id="newStatus">
                        <option value="confirmed">å·²ç¡®è®¤</option>
                        <option value="in_progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ›´æ–°åŸå› :</label>
                    <input type="text" id="updateReason" value="æµ‹è¯•è®¢å•çŠ¶æ€æ›´æ–°">
                </div>
                <button onclick="testPushOrderStatus()">æ¨é€è®¢å•çŠ¶æ€æ›´æ–°</button>
                <div id="pushResult" class="api-result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- æ—¥å¿—æ˜¾ç¤º -->
        <div class="test-section">
            <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        let websocket = null;
        let userId = null;

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusElement.textContent = `WebSocketå·²è¿æ¥ (ç”¨æˆ·ID: ${userId})`;
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'WebSocketæœªè¿æ¥';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            userId = document.getElementById('userId').value;
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            const wsUrl = `ws://localhost:8080/ws/order-status?userId=${userId}`;
            addLog(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`, 'info');

            try {
                websocket = new WebSocket(wsUrl);

                websocket.onopen = function(event) {
                    addLog('âœ… WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                    updateConnectionStatus(true);
                };

                websocket.onmessage = function(event) {
                    addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'websocket');
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'order_status_update') {
                            addLog(`ğŸ“¦ è®¢å•çŠ¶æ€æ›´æ–°: ${JSON.stringify(message.data, null, 2)}`, 'websocket');
                        }
                    } catch (e) {
                        // éJSONæ¶ˆæ¯ï¼Œç›´æ¥æ˜¾ç¤º
                    }
                };

                websocket.onclose = function(event) {
                    addLog(`âŒ WebSocketè¿æ¥å·²å…³é—­: ${event.code} - ${event.reason}`, 'error');
                    updateConnectionStatus(false);
                };

                websocket.onerror = function(error) {
                    addLog(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                    updateConnectionStatus(false);
                };

            } catch (error) {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        // å‘é€å¿ƒè·³
        function sendPing() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send('ping');
                addLog('ğŸ’“ å‘é€å¿ƒè·³: ping', 'info');
            } else {
                alert('WebSocketæœªè¿æ¥');
            }
        }

        // æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealthCheck() {
            try {
                addLog('ğŸ” æµ‹è¯•WebSocketå¥åº·æ£€æŸ¥...', 'info');
                const response = await fetch('http://localhost:8080/api/test/websocket/health');
                const result = await response.text();
                
                const resultElement = document.getElementById('healthResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result success';
                resultElement.textContent = result;
                
                addLog(`âœ… å¥åº·æ£€æŸ¥ç»“æœ: ${result}`, 'success');
            } catch (error) {
                const resultElement = document.getElementById('healthResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result error';
                resultElement.textContent = `é”™è¯¯: ${error.message}`;
                
                addLog(`âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è¿æ¥æ•°
        async function testConnectionCount() {
            try {
                addLog('ğŸ” è·å–WebSocketè¿æ¥æ•°...', 'info');
                const response = await fetch('http://localhost:8080/api/test/websocket/connection-count');
                const result = await response.text();
                
                const resultElement = document.getElementById('healthResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result success';
                resultElement.textContent = result;
                
                addLog(`âœ… è¿æ¥æ•°æŸ¥è¯¢ç»“æœ: ${result}`, 'success');
            } catch (error) {
                const resultElement = document.getElementById('healthResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result error';
                resultElement.textContent = `é”™è¯¯: ${error.message}`;
                
                addLog(`âŒ è¿æ¥æ•°æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¨é€è®¢å•çŠ¶æ€
        async function testPushOrderStatus() {
            const targetUserId = document.getElementById('targetUserId').value;
            const orderId = document.getElementById('orderId').value;
            const orderNo = document.getElementById('orderNo').value;
            const oldStatus = document.getElementById('oldStatus').value;
            const newStatus = document.getElementById('newStatus').value;
            const updateReason = document.getElementById('updateReason').value;

            if (!targetUserId || !orderId || !orderNo) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯');
                return;
            }

            try {
                addLog(`ğŸš€ æ¨é€è®¢å•çŠ¶æ€æ›´æ–°: ç”¨æˆ·${targetUserId}, è®¢å•${orderId}, ${oldStatus}â†’${newStatus}`, 'info');
                
                const url = `http://localhost:8080/api/test/websocket/push-order-status?userId=${targetUserId}&orderId=${orderId}&orderNo=${encodeURIComponent(orderNo)}&oldStatus=${oldStatus}&newStatus=${newStatus}&reason=${encodeURIComponent(updateReason)}`;
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                const result = await response.text();
                
                const resultElement = document.getElementById('pushResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result success';
                resultElement.textContent = result;
                
                addLog(`âœ… æ¨é€ç»“æœ: ${result}`, 'success');
            } catch (error) {
                const resultElement = document.getElementById('pushResult');
                resultElement.style.display = 'block';
                resultElement.className = 'api-result error';
                resultElement.textContent = `é”™è¯¯: ${error.message}`;
                
                addLog(`âŒ æ¨é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            addLog('ğŸ‰ WebSocket APIæµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
            addLog('ğŸ’¡ ä½¿ç”¨è¯´æ˜:', 'info');
            addLog('1. é¦–å…ˆè¿æ¥WebSocket (è¾“å…¥ç”¨æˆ·ID)', 'info');
            addLog('2. æµ‹è¯•å¥åº·æ£€æŸ¥å’Œè¿æ¥æ•°æŸ¥è¯¢', 'info');
            addLog('3. æ¨é€è®¢å•çŠ¶æ€æ›´æ–°ï¼Œè§‚å¯ŸWebSocketæ˜¯å¦èƒ½å®æ—¶æ¥æ”¶', 'info');
        };
    </script>
</body>
</html>