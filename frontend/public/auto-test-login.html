<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–ç™»å½•æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .auto-test {
            background-color: #28a745;
        }
        .auto-test:hover {
            background-color: #1e7e34;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ è‡ªåŠ¨åŒ–ç™»å½•æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸš€ è‡ªåŠ¨æµ‹è¯•æ§åˆ¶</h2>
        <button class="auto-test" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let testResults = [];

        function addResult(test, status, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                test,
                status,
                message,
                data,
                timestamp
            };
            testResults.push(result);
            displayResults();
        }

        function displayResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => {
                const statusClass = result.status === 'success' ? 'success' : 
                                  result.status === 'error' ? 'error' : 
                                  result.status === 'loading' ? 'loading' : 'info';
                
                let content = `<strong>[${result.timestamp}] ${result.test}</strong><br>${result.message}`;
                if (result.data) {
                    content += `<br><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                }
                
                return `<div class="test-result ${statusClass}">${content}</div>`;
            }).join('');
            
            // æ»šåŠ¨åˆ°æœ€æ–°ç»“æœ
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            testResults = [];
            displayResults();
        }

        async function testBackendConnection() {
            addResult('åç«¯è¿æ¥æµ‹è¯•', 'loading', 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...');
            try {
                // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„OPTIONSè¯·æ±‚æµ‹è¯•è¿æ¥
                const response = await axios.options(`${API_BASE}/auth/login`, {
                    timeout: 5000
                });
                addResult('åç«¯è¿æ¥æµ‹è¯•', 'success', 'åç«¯è¿æ¥æˆåŠŸ', {status: response.status});
                return true;
            } catch (error) {
                // å¦‚æœOPTIONSå¤±è´¥ï¼Œå°è¯•ç›´æ¥è®¿é—®ç™»å½•ç«¯ç‚¹ï¼ˆä¼šè¿”å›405ä½†è¯æ˜è¿æ¥æ­£å¸¸ï¼‰
                try {
                    await axios.get(`${API_BASE}/auth/login`);
                } catch (getError) {
                    if (getError.response && getError.response.status === 405) {
                        addResult('åç«¯è¿æ¥æµ‹è¯•', 'success', 'åç«¯è¿æ¥æˆåŠŸï¼ˆé€šè¿‡405å“åº”ç¡®è®¤ï¼‰', {status: 405});
                        return true;
                    }
                }
                addResult('åç«¯è¿æ¥æµ‹è¯•', 'error', `åç«¯è¿æ¥å¤±è´¥: ${error.message}`, error.response?.data);
                return false;
            }
        }

        async function testDatabaseUser() {
            addResult('æ•°æ®åº“ç”¨æˆ·æŸ¥è¯¢', 'info', 'è·³è¿‡æ•°æ®åº“ç”¨æˆ·æŸ¥è¯¢ï¼ˆæ— å¯¹åº”APIç«¯ç‚¹ï¼‰');
            return true;
        }

        async function testAdminLogin() {
            addResult('ç®¡ç†å‘˜ç™»å½•æµ‹è¯•', 'loading', 'æ­£åœ¨æµ‹è¯•adminç™»å½•...');
            try {
                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };
                
                const response = await axios.post(`${API_BASE}/auth/login`, loginData, {
                    timeout: 10000,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.data.success && response.data.data.token) {
                    // ä¿å­˜token
                    localStorage.setItem('token', response.data.data.token);
                    localStorage.setItem('userInfo', JSON.stringify(response.data.data.userInfo));
                    
                    addResult('ç®¡ç†å‘˜ç™»å½•æµ‹è¯•', 'success', 'ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼', {
                        token: response.data.data.token.substring(0, 20) + '...',
                        userInfo: response.data.data.userInfo
                    });
                    return true;
                } else {
                    addResult('ç®¡ç†å‘˜ç™»å½•æµ‹è¯•', 'error', 'ç™»å½•å“åº”æ ¼å¼å¼‚å¸¸', response.data);
                    return false;
                }
            } catch (error) {
                addResult('ç®¡ç†å‘˜ç™»å½•æµ‹è¯•', 'error', `ç™»å½•å¤±è´¥: ${error.message}`, {
                    status: error.response?.status,
                    data: error.response?.data,
                    config: {
                        url: error.config?.url,
                        method: error.config?.method,
                        data: error.config?.data
                    }
                });
                return false;
            }
        }

        async function testAuthStatus() {
            addResult('è®¤è¯çŠ¶æ€æµ‹è¯•', 'loading', 'æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    addResult('è®¤è¯çŠ¶æ€æµ‹è¯•', 'error', 'æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    return false;
                }

                const response = await axios.get(`${API_BASE}/auth/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    timeout: 5000
                });
                
                addResult('è®¤è¯çŠ¶æ€æµ‹è¯•', 'success', 'è®¤è¯çŠ¶æ€æ£€æŸ¥æˆåŠŸ', response.data);
                return true;
            } catch (error) {
                addResult('è®¤è¯çŠ¶æ€æµ‹è¯•', 'error', `è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, error.response?.data);
                return false;
            }
        }

        async function testPaymentRecords() {
            addResult('æ”¯ä»˜è®°å½•è®¿é—®æµ‹è¯•', 'loading', 'æ­£åœ¨æµ‹è¯•æ”¯ä»˜è®°å½•é¡µé¢è®¿é—®...');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    addResult('æ”¯ä»˜è®°å½•è®¿é—®æµ‹è¯•', 'error', 'æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    return false;
                }

                const response = await axios.get(`${API_BASE}/payment/records`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    params: {
                        page: 1,
                        size: 10
                    },
                    timeout: 10000
                });
                
                addResult('æ”¯ä»˜è®°å½•è®¿é—®æµ‹è¯•', 'success', 'æ”¯ä»˜è®°å½•è®¿é—®æˆåŠŸ', {
                    total: response.data.data?.total || 0,
                    records: response.data.data?.records?.length || 0
                });
                return true;
            } catch (error) {
                addResult('æ”¯ä»˜è®°å½•è®¿é—®æµ‹è¯•', 'error', `æ”¯ä»˜è®°å½•è®¿é—®å¤±è´¥: ${error.message}`, {
                    status: error.response?.status,
                    data: error.response?.data
                });
                return false;
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('è‡ªåŠ¨åŒ–æµ‹è¯•', 'info', 'å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // 1. æµ‹è¯•åç«¯è¿æ¥
            const backendOk = await testBackendConnection();
            if (!backendOk) {
                addResult('è‡ªåŠ¨åŒ–æµ‹è¯•', 'error', 'åç«¯è¿æ¥å¤±è´¥ï¼Œåœæ­¢æµ‹è¯•');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. æµ‹è¯•æ•°æ®åº“ç”¨æˆ·
            await testDatabaseUser();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. æµ‹è¯•ç™»å½•
            const loginOk = await testAdminLogin();
            if (!loginOk) {
                addResult('è‡ªåŠ¨åŒ–æµ‹è¯•', 'error', 'ç™»å½•å¤±è´¥ï¼Œåœæ­¢åç»­æµ‹è¯•');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 4. æµ‹è¯•è®¤è¯çŠ¶æ€
            await testAuthStatus();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 5. æµ‹è¯•æ”¯ä»˜è®°å½•è®¿é—®
            await testPaymentRecords();
            
            addResult('è‡ªåŠ¨åŒ–æµ‹è¯•', 'success', 'æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºåˆå§‹çŠ¶æ€
        window.onload = function() {
            addResult('ç³»ç»Ÿåˆå§‹åŒ–', 'info', 'è‡ªåŠ¨åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>